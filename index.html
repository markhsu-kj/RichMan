<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡´å¯Œæ–¹æ¡ˆ v7.0 - éˆæ´»å ±åƒ¹ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; background: #f1f5f9; padding-bottom: 220px; }
        .card { background: white; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .input-box { border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; width: 100%; font-weight: 800; text-align: center; }
        .price-input { background: #fffbeb; color: #b45309; border: 2px solid #fde68a; transition: all 0.3s; }
        .price-input:focus { border-color: #f59e0b; outline: none; background: #fef3c7; }
        .alert-flash { animation: pulse-red 2s infinite; border: 4px solid #ef4444 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="p-4">

    <div id="quarterlyAlert" class="hidden card p-4 mb-2 bg-indigo-600 text-white text-center">
        <p class="text-xs font-black">ğŸ“… å­£åº¦å¹³è¡¡æé†’ï¼šæ–°å­£åº¦å·²é–‹å§‹ï¼Œè«‹æª¢è¦– M=R</p>
    </div>
    <div id="strategyAlert" class="hidden card p-4 mb-4 bg-red-600 text-white text-center">
        <p class="text-xs font-black animate-bounce">âš ï¸ ç­–ç•¥è­¦å‘Šï¼šè™§æé” 10% è‡¨ç•Œé» âš ï¸</p>
    </div>

    <div id="mainDashboard" class="card p-6 mb-4 text-center border-t-8 border-slate-800 transition-all duration-500">
        <p class="text-[10px] font-black text-slate-400 tracking-widest uppercase mb-1">Total Assets (M + R)</p>
        <h1 id="totalAssets" class="text-4xl font-black text-slate-800 tracking-tighter">NT$ 0</h1>
        <div class="flex justify-center gap-4 mt-4 pt-4 border-t border-slate-50">
            <div class="text-left"><p class="text-[9px] font-bold text-slate-400 uppercase">å¸‚å ´ç¾å€¼ M</p><p id="totalMValue" class="text-lg font-black text-blue-600">--</p></div>
            <div class="text-left border-l pl-4"><p class="text-[9px] font-bold text-slate-400 uppercase">ä¿ç•™è³‡é‡‘ R</p><p id="totalRValue" class="text-lg font-black text-green-600">--</p></div>
        </div>
    </div>

    <div id="buyPointsArea" class="grid grid-cols-2 gap-3 mb-4"></div>

    <div class="flex justify-between items-center mb-2 px-1">
        <span id="updateTime" class="text-[9px] font-bold text-slate-400 italic">ç³»çµ±æº–å‚™ä¸­...</span>
        <button onclick="fetchAllPrices()" class="text-[9px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100 active:bg-blue-200">ğŸ”„ ç«‹å³åŒæ­¥æœ€æ–°å¸‚åƒ¹</button>
    </div>

    <div class="grid grid-cols-3 gap-2 mb-4">
        <div>
            <p class="text-[9px] font-black mb-1 text-slate-500 text-center uppercase">00631L å¸‚åƒ¹</p>
            <input type="number" id="curP631" class="input-box price-input" oninput="manualUpdate()">
        </div>
        <div>
            <p class="text-[9px] font-black mb-1 text-slate-500 text-center uppercase">QLD å¸‚åƒ¹</p>
            <input type="number" id="curPQLD" class="input-box price-input" oninput="manualUpdate()">
        </div>
        <div>
            <p class="text-[9px] font-black mb-1 text-slate-500 text-center uppercase">æœ¬é‡‘ R (è¬)</p>
            <input type="number" id="rInput" class="input-box !bg-green-50 !text-green-700 border-green-200" oninput="manualUpdate()">
        </div>
    </div>

    <div class="card p-4 mb-4 border-2 border-slate-100">
        <div class="grid grid-cols-3 gap-2 mb-2">
            <select id="newType" class="input-box text-xs !text-left"><option value="00631L">00631L</option><option value="QLD">QLD</option></select>
            <input type="number" id="newQty" class="input-box text-xs" placeholder="è‚¡æ•¸">
            <input type="number" id="newPrice" class="input-box text-xs" placeholder="å–®åƒ¹">
        </div>
        <button onclick="addTrade()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg active:scale-95 transition">æ–°å¢ç´€éŒ„</button>
    </div>

    <div id="tradeList" class="space-y-1 mb-4"></div>

    <div class="fixed bottom-6 left-4 right-4">
        <button onclick="calcBalance()" class="w-full bg-slate-900 text-white font-black py-5 rounded-3xl shadow-2xl active:scale-95 transition">
            âš–ï¸ åŸ·è¡Œ M=R æˆ°ç•¥å¹³è¡¡å»ºè­°
        </button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-6 z-50 backdrop-blur-md">
        <div class="bg-white rounded-[32px] w-full p-8 max-w-sm">
            <div id="res" class="space-y-4"></div>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full mt-8 bg-slate-900 text-white py-4 rounded-2xl font-black">æ”¶æ‚‰</button>
        </div>
    </div>

    <script>
        let trades = JSON.parse(localStorage.getItem('myTrades')) || [];
        let autoUpdateEnabled = true;

        async function fetchAllPrices() {
            document.getElementById('updateTime').innerText = "ğŸ“¡ æ­£åœ¨åŒæ­¥é›™å¸‚å ´å ±åƒ¹...";
            try {
                // æŠ“å– QLD (US)
                const qldUrl = encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/QLD');
                const qldRes = await fetch(`https://api.allorigins.win/get?url=${qldUrl}`);
                const qldData = JSON.parse((await qldRes.json()).contents);
                const qldPrice = qldData.chart.result[0].meta.regularMarketPrice;

                // æŠ“å– 00631L (TW)
                const twUrl = encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/00631L.TW');
                const twRes = await fetch(`https://api.allorigins.win/get?url=${twUrl}`);
                const twData = JSON.parse((await twRes.json()).contents);
                const twPrice = twData.chart.result[0].meta.regularMarketPrice;

                if(qldPrice) document.getElementById('curPQLD').value = qldPrice.toFixed(2);
                if(twPrice) document.getElementById('curP631').value = twPrice.toFixed(2);

                document.getElementById('updateTime').innerText = "âœ… å·²åŒæ­¥ï¼š" + new Date().toLocaleTimeString();
                run();
            } catch (e) {
                document.getElementById('updateTime').innerText = "âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥";
            }
        }

        // ç•¶ä½¿ç”¨è€…æ‰‹å‹•è¼¸å…¥æ™‚å‘¼å«
        function manualUpdate() {
            autoUpdateEnabled = false; // æ‰‹å‹•è¼¸å…¥å¾Œæš«æ™‚åœæ­¢è‡ªå‹•åˆ·æ–°è¦†è“‹
            document.getElementById('updateTime').innerText = "âœï¸ æ‰‹å‹•èª¿æ•´æ¨¡å¼";
            run();
        }

        function run() {
            const curP631 = parseFloat(document.getElementById('curP631').value) || 0;
            const curPQLD = parseFloat(document.getElementById('curPQLD').value) || 0;
            const rVal = (parseFloat(document.getElementById('rInput').value) || 0) * 10000;
            const curRate = 32.5;

            let twCostTotal = 0, twVal = 0, usCostTotal = 0, usVal = 0, twQty = 0, usQty = 0;

            trades.forEach(t => {
                if(t.type === "00631L") {
                    twCostTotal += t.qty * t.price; twVal += t.qty * curP631; twQty += t.qty;
                } else {
                    usCostTotal += t.qty * t.price; usVal += t.qty * curPQLD * curRate; usQty += t.qty;
                }
            });

            const totalM = twVal + usVal;
            const totalCostNT = twCostTotal + (usCostTotal * curRate);
            const totalAssets = totalM + rVal;
            const lossPct = totalCostNT > 0 ? (totalM - totalCostNT) / totalCostNT : 0;

            document.getElementById('totalAssets').innerText = "NT$ " + Math.round(totalAssets).toLocaleString();
            document.getElementById('totalMValue').innerText = "NT$ " + Math.round(totalM).toLocaleString();
            document.getElementById('totalRValue').innerText = "NT$ " + Math.round(rVal).toLocaleString();

            // è™§æè­¦å ±
            if (lossPct <= -0.10) {
                document.getElementById('strategyAlert').classList.remove('hidden');
                document.getElementById('mainDashboard').classList.add('alert-flash');
            } else {
                document.getElementById('strategyAlert').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('alert-flash');
            }

            // å­£åº¦æé†’
            const now = new Date();
            if ([0, 3, 6, 9].includes(now.getMonth()) && now.getDate() <= 7) {
                document.getElementById('quarterlyAlert').classList.remove('hidden');
            }

            // æ›´æ–°åŠ ç¢¼é»
            let bpa = "";
            if(twQty > 0) bpa += renderBP('00631L åŠ ç¢¼é»', twCostTotal/twQty);
            if(usQty > 0) bpa += renderBP('QLD åŠ ç¢¼é»', usCostTotal/usQty);
            document.getElementById('buyPointsArea').innerHTML = bpa;

            // æ¸…å–®æ›´æ–°
            let listHtml = "";
            trades.slice().reverse().forEach(t => {
                listHtml += `<div class="bg-white p-2 rounded-lg text-[10px] flex justify-between border mb-1">
                    <span class="font-bold">${t.type} | ${t.qty}è‚¡ @${t.price}</span>
                    <button onclick="deleteTrade(${t.id})" class="text-red-300 px-2">âœ•</button>
                </div>`;
            });
            document.getElementById('tradeList').innerHTML = listHtml;

            // å„²å­˜ç‹€æ…‹
            localStorage.setItem('rInput', document.getElementById('rInput').value);
        }

        function renderBP(name, avg) {
            return `<div class="card p-3 border-l-4 border-blue-500 bg-blue-50">
                <p class="text-[9px] font-black text-blue-600 uppercase mb-1">${name}</p>
                <p class="text-lg font-black text-slate-800">${(avg * 0.9).toFixed(2)}</p>
            </div>`;
        }

        function addTrade() {
            const type = document.getElementById('newType').value;
            const qty = parseFloat(document.getElementById('newQty').value);
            const price = parseFloat(document.getElementById('newPrice').value);
            if (!qty || !price) return;
            trades.push({ id: Date.now(), type, qty, price });
            localStorage.setItem('myTrades', JSON.stringify(trades));
            run();
        }

        function deleteTrade(id) {
            trades = trades.filter(t => t.id !== id);
            localStorage.setItem('myTrades', JSON.stringify(trades));
            run();
        }

        function calcBalance() {
            const curP631 = parseFloat(document.getElementById('curP631').value) || 1;
            const curPQLD = parseFloat(document.getElementById('curPQLD').value) || 1;
            const rVal = (parseFloat(document.getElementById('rInput').value) || 0) * 10000;
            let s631 = 0, sQLD = 0;
            trades.forEach(t => { if(t.type==="00631L") s631 += t.qty; else sQLD += t.qty; });
            const totalAssets = (s631 * curP631) + (sQLD * curPQLD * 32.5) + rVal;
            const targetEach = (totalAssets / 2) / 2;
            document.getElementById('res').innerHTML = `
                <h3 class="font-black text-xl mb-4 italic uppercase tracking-tighter">Balance Advice</h3>
                <div class="space-y-4">
                    <div class="p-3 bg-slate-50 rounded-xl">
                        <p class="text-[10px] font-bold text-slate-400">00631L ç›®æ¨™è‚¡æ•¸</p>
                        <p class="text-xl font-black">${Math.round(targetEach/curP631).toLocaleString()} <span class="text-xs">è‚¡</span></p>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-xl">
                        <p class="text-[10px] font-bold text-slate-400">QLD ç›®æ¨™è‚¡æ•¸</p>
                        <p class="text-xl font-black">${Math.round(targetEach/32.5/curPQLD).toLocaleString()} <span class="text-xs">è‚¡</span></p>
                    </div>
                    <div class="p-3 bg-green-50 rounded-xl border-l-4 border-green-500">
                        <p class="text-[10px] font-bold text-green-600">ç¾é‡‘ R å„²å‚™ (50%)</p>
                        <p class="text-xl font-black text-green-700">NT$ ${Math.round(totalAssets/2).toLocaleString()}</p>
                    </div>
                </div>`;
            document.getElementById('modal').classList.remove('hidden');
        }

        window.onload = () => {
            document.getElementById('rInput').value = localStorage.getItem('rInput') || 500;
            fetchAllPrices();
            // æ¯ 5 åˆ†é˜å¾Œå°è‡ªå‹•æ‚„æ‚„åŒæ­¥ä¸€æ¬¡ï¼Œé™¤éä½¿ç”¨è€…æ­£åœ¨æ‰‹å‹•è¼¸å…¥
            setInterval(() => { if(autoUpdateEnabled) fetchAllPrices(); }, 300000);
        };
    </script>
</body>
</html>
