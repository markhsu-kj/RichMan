<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>致富方案 v6.4 - 深度分析版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; background: #f8fafc; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
        .input-box { border: 1px solid #e2e8f0; border-radius: 8px; padding: 6px; width: 100%; background: #f8fafc; font-size: 13px; font-weight: bold; }
        .stat-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 16px; font-weight: 900; color: #1e293b; }
    </style>
</head>
<body class="p-4 pb-48">

    <div class="mb-6">
        <div class="flex justify-between items-end mb-1 px-1">
            <span class="text-[10px] font-black bg-slate-800 text-white px-2 py-0.5 rounded">V6.4 ANALYSIS</span>
            <span id="updateTime" class="text-[10px] text-slate-400 font-bold">同步中...</span>
        </div>
        <div class="card p-6 border-b-4 border-slate-800 text-center">
            <p class="stat-label mb-1">總資產淨值 (M + R)</p>
            <h1 id="totalAssets" class="text-4xl font-black text-slate-800 tracking-tighter">NT$ 0</h1>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="card p-4 border-l-4 border-blue-500">
            <p class="stat-label">市場現值 M</p>
            <p id="totalMValue" class="stat-value text-blue-600">--</p>
        </div>
        <div class="card p-4 border-l-4 border-green-500">
            <p class="stat-label">保留資金 R</p>
            <p id="totalRValue" class="stat-value text-green-600">--</p>
        </div>
    </div>

    <div class="card p-4 mb-6">
        <h2 class="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest text-center">資產權重分配</h2>
        <div style="height: 180px;"><canvas id="ratioChart"></canvas></div>
    </div>

    <div class="card p-5 mb-6 bg-slate-900 text-white">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">投資績效戰報</h2>
            <button onclick="toggleProfitView()" class="text-[10px] bg-slate-700 px-2 py-1 rounded-md font-bold">切換 額/%</button>
        </div>
        
        <div class="space-y-4">
            <div class="flex justify-between items-center border-b border-slate-800 pb-2">
                <span class="text-xs font-bold text-slate-400">總庫存合計</span>
                <div class="text-right">
                    <div id="aggValue" class="font-black text-lg">--</div>
                    <div id="aggProfit" class="text-[10px] font-bold">--</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-[9px] font-bold text-blue-400 mb-1">00631L (台股)</p>
                    <p id="twValue" class="text-sm font-black">--</p>
                    <p id="twProfit" class="text-[10px] font-bold">--</p>
                </div>
                <div>
                    <p class="text-[9px] font-bold text-indigo-400 mb-1">QLD (美股)</p>
                    <p id="usValue" class="text-sm font-black">--</p>
                    <p id="usProfit" class="text-[10px] font-bold">--</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-2 mb-6">
        <div><p class="stat-label mb-1">631L 市價</p><input type="number" id="curP631" class="input-box" oninput="run()"></div>
        <div><p class="stat-label mb-1">QLD 市價</p><input type="number" id="curPQLD" class="input-box" oninput="run()"></div>
        <div><p class="stat-label mb-1">R (萬)</p><input type="number" id="rInput" class="input-box text-green-600" oninput="run()"></div>
    </div>

    <div class="card p-4 mb-6 border-dashed border-2 border-slate-200">
        <div class="flex gap-2 mb-3">
            <button id="btnBuy" onclick="setMode('buy')" class="flex-1 py-1 text-[10px] font-black rounded-lg tab-active">買入</button>
            <button id="btnSell" onclick="setMode('sell')" class="flex-1 py-1 text-[10px] font-black rounded-lg tab-inactive">賣出</button>
        </div>
        <div class="grid grid-cols-3 gap-2">
            <select id="newType" class="input-box col-span-1"><option value="00631L">631L</option><option value="QLD">QLD</option></select>
            <input type="number" id="newQty" class="input-box col-span-1" placeholder="股數">
            <input type="number" id="newPrice" class="input-box col-span-1" placeholder="成交價">
        </div>
        <button onclick="addTrade()" class="w-full mt-2 bg-blue-600 text-white font-black py-2 rounded-lg text-xs">新增至交易清單</button>
    </div>

    <div id="tradeList" class="space-y-2 mb-10"></div>

    <div class="fixed bottom-4 left-4 right-4">
        <button onclick="calcBalance()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl shadow-2xl active:scale-95 transition">
            ⚖️ 執行 M=R 戰略平衡建議
        </button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-6 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full p-6 shadow-2xl max-w-sm">
            <h3 class="font-black text-xl mb-4 text-slate-800">⚖️ 戰略平衡建議</h3>
            <div id="res" class="space-y-3"></div>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full mt-6 bg-slate-800 text-white py-3 rounded-xl font-bold">了解</button>
        </div>
    </div>

    <script>
        let trades = JSON.parse(localStorage.getItem('myTrades')) || [];
        let currentMode = 'buy';
        let showPercent = false;
        let chart;

        function toggleProfitView() { showPercent = !showPercent; run(); }

        function initChart() {
            const ctx = document.getElementById('ratioChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['00631L', 'QLD', 'R Cash'],
                    datasets: [{
                        data: [0, 0, 100],
                        backgroundColor: ['#3b82f6', '#6366f1', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '75%', plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false }
            });
        }

        async function fetchLivePrices() {
            try {
                const res = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/QLD');
                const data = await res.json();
                const qldPrice = data.chart.result[0].meta.regularMarketPrice;
                if(qldPrice) document.getElementById('curPQLD').value = qldPrice.toFixed(2);
                document.getElementById('updateTime').innerText = "報價已同步 " + new Date().toLocaleTimeString();
                run();
            } catch (e) { document.getElementById('updateTime').innerText = "手動模式"; run(); }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnBuy').className = mode === 'buy' ? 'flex-1 py-1 text-[10px] font-black rounded-lg tab-active' : 'flex-1 py-1 text-[10px] font-black rounded-lg tab-inactive';
            document.getElementById('btnSell').className = mode === 'sell' ? 'flex-1 py-1 text-[10px] font-black rounded-lg tab-active' : 'flex-1 py-1 text-[10px] font-black rounded-lg tab-inactive';
        }

        function addTrade() {
            const type = document.getElementById('newType').value;
            let qty = parseFloat(document.getElementById('newQty').value);
            const price = parseFloat(document.getElementById('newPrice').value);
            if (!qty || !price) return;
            if(currentMode === 'sell') qty = -Math.abs(qty);
            trades.push({ id: Date.now(), type, qty, price, date: new Date().toLocaleDateString() });
            localStorage.setItem('myTrades', JSON.stringify(trades));
            document.getElementById('newQty').value = ""; document.getElementById('newPrice').value = "";
            run();
        }

        function deleteTrade(id) { if(confirm("刪除？")) { trades = trades.filter(t => t.id !== id); localStorage.setItem('myTrades', JSON.stringify(trades)); run(); } }

        function run() {
            const curP631 = parseFloat(document.getElementById('curP631').value) || 0;
            const curPQLD = parseFloat(document.getElementById('curPQLD').value) || 0;
            const curRate = 32.5; // 固定匯率範例
            const rVal = (parseFloat(document.getElementById('rInput').value) || 0) * 10000;
            
            let twCost = 0, twValue = 0, usCost = 0, usValue = 0, s631Q = 0, sQLDQ = 0;

            trades.forEach(t => {
                const is631 = t.type === "00631L";
                if(is631) {
                    twCost += t.qty * t.price;
                    twValue += t.qty * curP631;
                    s631Q += t.qty;
                } else {
                    usCost += t.qty * t.price * curRate;
                    usValue += t.qty * curPQLD * curRate;
                    sQLDQ += t.qty;
                }
            });

            const totalM = twValue + usValue;
            const totalAssets = totalM + rVal;
            const aggProfit = (twValue + usValue) - (twCost + usCost);

            // 介面更新
            document.getElementById('totalAssets').innerText = "NT$ " + Math.round(totalAssets).toLocaleString();
            document.getElementById('totalMValue').innerText = Math.round(totalM/10000) + " 萬";
            document.getElementById('totalRValue').innerText = Math.round(rVal/10000) + " 萬";
            
            document.getElementById('aggValue').innerText = "NT$ " + Math.round(totalM).toLocaleString();
            document.getElementById('aggProfit').innerText = showPercent ? ((aggProfit/(twCost+usCost)*100).toFixed(2) + "%") : ("賺 NT$ " + Math.round(aggProfit).toLocaleString());
            document.getElementById('aggProfit').className = aggProfit >= 0 ? "text-[10px] font-bold text-red-400" : "text-[10px] font-bold text-green-400";

            document.getElementById('twValue').innerText = Math.round(twValue/10000) + " 萬";
            document.getElementById('twProfit').innerText = showPercent ? ((twValue-twCost)/twCost*100).toFixed(1) + "%" : "賺 " + Math.round((twValue-twCost)/1000).toLocaleString() + "k";
            document.getElementById('twProfit').className = (twValue-twCost) >= 0 ? "text-[10px] font-bold text-red-400" : "text-[10px] font-bold text-green-400";

            document.getElementById('usValue').innerText = Math.round(usValue/10000) + " 萬";
            document.getElementById('usProfit').innerText = showPercent ? ((usValue-usCost)/usCost*100).toFixed(1) + "%" : "賺 " + Math.round((usValue-usCost)/1000).toLocaleString() + "k";
            document.getElementById('usProfit').className = (usValue-usCost) >= 0 ? "text-[10px] font-bold text-red-400" : "text-[10px] font-bold text-green-400";

            // 清單與圖表
            updateChart(twValue, usValue, rVal);
            document.getElementById('ratioDisplay').innerText = `目前持有：631L ${Math.round(s631Q)}股 | QLD ${Math.round(sQLDQ)}股`;
        }

        function updateChart(tw, us, r) {
            if(!chart) return;
            chart.data.datasets[0].data = [tw, us, r];
            chart.update();
        }

        function calcBalance() {
            // ... (保留之前的平衡計算邏輯)
            const curP631 = parseFloat(document.getElementById('curP631').value) || 1;
            const curPQLD = parseFloat(document.getElementById('curPQLD').value) || 1;
            const rVal = (parseFloat(document.getElementById('rInput').value) || 0) * 10000;
            let s631 = 0, sQLD = 0;
            trades.forEach(t => { if(t.type==="00631L") s631 += t.qty; else sQLD += t.qty; });
            const totalM = (s631 * curP631) + (sQLD * curPQLD * 32.5);
            const totalAssets = totalM + rVal;
            const targetAsset = totalAssets / 4;
            const d631 = (targetAsset / curP631) - s631;
            const dQLD = ((targetAsset / 32.5) / curPQLD) - sQLD;

            document.getElementById('res').innerHTML = `<p class='text-sm'>00631L: ${Math.round(d631)} 股</p><p class='text-sm'>QLD: ${Math.round(dQLD)} 股</p>`;
            document.getElementById('modal').classList.remove('hidden');
        }

        window.onload = () => {
            initChart();
            document.getElementById('curP631').value = 265;
            document.getElementById('curPQLD').value = 108;
            document.getElementById('rInput').value = 500;
            fetchLivePrices();
        };
    </script>
</body>
</html>
