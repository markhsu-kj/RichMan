<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>致富方案 v6.6 - 精確戰略版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; background: #f1f5f9; padding-bottom: 180px; }
        .card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .input-box { border: 1px solid #e2e8f0; border-radius: 10px; padding: 8px; width: 100%; background: #ffffff; font-size: 14px; font-weight: 800; }
        .price-input { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
        .tab-active { background: #1e293b; color: white; }
    </style>
</head>
<body class="p-4">

    <div class="card p-6 mb-4 text-center border-t-8 border-slate-800">
        <p class="text-[10px] font-black text-slate-400 tracking-widest uppercase mb-1">Total Net Assets (M + R)</p>
        <h1 id="totalAssets" class="text-4xl font-black text-slate-800 tracking-tighter">NT$ 0</h1>
        <div class="flex justify-center gap-4 mt-4 pt-4 border-t border-slate-50">
            <div class="text-left">
                <p class="text-[9px] font-bold text-slate-400 uppercase">市場現值 M</p>
                <p id="totalMValue" class="text-lg font-black text-blue-600">--</p>
            </div>
            <div class="text-left border-l pl-4">
                <p class="text-[9px] font-bold text-slate-400 uppercase">保留資金 R</p>
                <p id="totalRValue" class="text-lg font-black text-green-600">--</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-5 gap-4 mb-4">
        <div class="col-span-3 card p-4 bg-slate-900 text-white">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] font-black text-slate-400">績效分析</span>
                <button onclick="toggleProfitView()" class="text-[9px] bg-slate-700 px-2 py-0.5 rounded">NT$ / %</button>
            </div>
            <div class="space-y-3">
                <div>
                    <div class="flex justify-between text-[11px] mb-1"><span>00631L</span><span id="twProfit" class="font-bold">--</span></div>
                    <div id="twValue" class="text-sm font-black text-blue-400">--</div>
                </div>
                <div class="border-t border-slate-800 pt-2">
                    <div class="flex justify-between text-[11px] mb-1"><span>QLD (美)</span><span id="usProfit" class="font-bold">--</span></div>
                    <div id="usValue" class="text-sm font-black text-indigo-400">--</div>
                </div>
            </div>
        </div>
        <div class="col-span-2 card p-2 flex items-center justify-center">
            <canvas id="ratioChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-3 gap-2 mb-4">
        <div><p class="text-[9px] font-black mb-1 text-slate-500">631L 市價</p><input type="number" id="curP631" class="input-box price-input" oninput="run()"></div>
        <div><p class="text-[9px] font-black mb-1 text-slate-500">QLD 市價</p><input type="number" id="curPQLD" class="input-box price-input" oninput="run()"></div>
        <div><p class="text-[9px] font-black mb-1 text-slate-500">本金 R(萬)</p><input type="number" id="rInput" class="input-box !bg-green-50 !text-green-700" oninput="run()"></div>
    </div>

    <div class="card p-4 mb-4 border-2 border-slate-100">
        <div class="flex gap-2 mb-3">
            <button id="btnBuy" onclick="setMode('buy')" class="flex-1 py-1.5 text-xs font-black rounded-lg tab-active">買入入庫</button>
            <button id="btnSell" onclick="setMode('sell')" class="flex-1 py-1.5 text-xs font-black rounded-lg bg-slate-100 text-slate-400">賣出減倉</button>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
            <select id="newType" class="input-box text-xs"><option value="00631L">00631L</option><option value="QLD">QLD</option></select>
            <input type="number" id="newQty" class="input-box text-xs" placeholder="股數">
            <input type="number" id="newPrice" class="input-box text-xs" placeholder="成交價">
        </div>
        <button onclick="addTrade()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl text-sm shadow-lg active:scale-95 transition">確認新增紀錄</button>
    </div>

    <h2 class="text-xs font-black text-slate-400 mb-2 px-1 uppercase tracking-widest">Transaction History</h2>
    <div id="tradeList" class="space-y-2"></div>

    <div class="fixed bottom-6 left-4 right-4 shadow-2xl">
        <button onclick="calcBalance()" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl flex items-center justify-center gap-3">
            ⚖️ 執行 M=R 戰略平衡計算
        </button>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-6 z-50 backdrop-blur-md">
        <div class="bg-white rounded-3xl w-full p-6 max-w-sm shadow-2xl">
            <h3 class="font-black text-xl mb-4 text-slate-800">戰略調整建議</h3>
            <div id="res" class="space-y-3"></div>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="w-full mt-6 bg-slate-800 text-white py-4 rounded-xl font-black">收悉，開始操作</button>
        </div>
    </div>

    <script>
        let trades = JSON.parse(localStorage.getItem('myTrades')) || [];
        let currentMode = 'buy';
        let showPercent = false;
        let chart;

        function toggleProfitView() { showPercent = !showPercent; run(); }

        function initChart() {
            const ctx = document.getElementById('ratioChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [1, 1, 1], backgroundColor: ['#3b82f6', '#6366f1', '#10b981'], borderWidth: 0 }] },
                options: { cutout: '65%', plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false }
            });
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnBuy').className = mode === 'buy' ? 'flex-1 py-1.5 text-xs font-black rounded-lg tab-active' : 'flex-1 py-1.5 text-xs font-black rounded-lg bg-slate-100 text-slate-400';
            document.getElementById('btnSell').className = mode === 'sell' ? 'flex-1 py-1.5 text-xs font-black rounded-lg bg-red-600 text-white' : 'flex-1 py-1.5 text-xs font-black rounded-lg bg-slate-100 text-slate-400';
        }

        function addTrade() {
            const type = document.getElementById('newType').value;
            let qty = parseFloat(document.getElementById('newQty').value);
            const price = parseFloat(document.getElementById('newPrice').value);
            if (!qty || !price) return;
            if(currentMode === 'sell') qty = -Math.abs(qty);
            trades.push({ id: Date.now(), type, qty, price, date: new Date().toLocaleDateString() });
            localStorage.setItem('myTrades', JSON.stringify(trades));
            document.getElementById('newQty').value = ""; document.getElementById('newPrice').value = "";
            run();
        }

        function deleteTrade(id) {
            if(confirm("確定刪除此筆交易？")) {
                trades = trades.filter(t => t.id !== id);
                localStorage.setItem('myTrades', JSON.stringify(trades));
                run();
            }
        }

        function run() {
            const curP631 = parseFloat(document.getElementById('curP631').value) || 0;
            const curPQLD = parseFloat(document.getElementById('curPQLD').value) || 0;
            const curRate = 32.5; 
            const rVal = (parseFloat(document.getElementById('rInput').value) || 0) * 10000;
            
            let twCost = 0, twVal = 0, usCost = 0, usVal = 0;

            trades.forEach(t => {
                if(t.type === "00631L") {
                    twCost += t.qty * t.price;
                    twVal += t.qty * curP631;
                } else {
                    usCost += t.qty * t.price * curRate;
                    usVal += t.qty * curPQLD * curRate;
                }
            });

            const totalM = twVal + usVal;
            const totalAssets = totalM + rVal;

            document.getElementById('totalAssets').innerText = "NT$ " + Math.round(totalAssets).toLocaleString();
            document.getElementById('totalMValue').innerText = "NT$ " + Math.round(totalM).toLocaleString();
            document.getElementById('totalRValue').innerText = "NT$ " + Math.round(rVal).toLocaleString();

            document.getElementById('twValue').innerText = "現值 NT$ " + Math.round(twVal).toLocaleString();
            document.getElementById('twProfit').innerText = showPercent ? (twCost ? ((twVal-twCost)/twCost*100).toFixed(2) + "%" : "0%") : (twVal-twCost).toLocaleString();
            document.getElementById('twProfit').className = (twVal-twCost) >= 0 ? "text-red-400 font-black" : "text-green-400 font-black";

            document.getElementById('usValue').innerText = "現值 NT$ " + Math.round(usVal).toLocaleString();
            document.getElementById('usProfit').innerText = showPercent ? (usCost ? ((usVal-usCost)/usCost*100).toFixed(2) + "%" : "0%") : (usVal-usCost).toLocaleString();
            document.getElementById('usProfit').className = (usVal-usCost) >= 0 ? "text-red-400 font-black" : "text-green-400 font-black";

            if(chart) {
                chart.data.datasets[0].data = [twVal || 0.1, usVal || 0.1, rVal || 0.1];
                chart.update();
            }

            let listHtml = "";
            trades.slice().reverse().forEach(t => {
                const is631 = t.type === "00631L";
                listHtml += `<div class="card p-4 flex justify-between items-center mb-2 border-l-4 ${t.qty>0?(is631?'border-blue-500':'border-indigo-500'):'border-red-500 bg-red-50/30'}">
                    <div>
                        <p class="text-[10px] font-black uppercase ${t.qty>0?'text-slate-400':'text-red-500'}">${t.qty>0?'Buy':'Sell'} ${t.type}</p>
                        <p class="text-xs font-black">${Math.abs(t.qty).toLocaleString()} 股 @ ${t.price}</p>
                    </div>
                    <button onclick="deleteTrade(${t.id})" class="text-slate-300 p-2">✕</button>
                </div>`;
            });
            document.getElementById('tradeList').innerHTML = listHtml;
        }

        function calcBalance() {
            const curP631 = parseFloat(document.getElementById('curP631').value) || 1;
            const curPQLD = parseFloat(document.getElementById('curPQLD').value) || 1;
            const rVal = (parseFloat(document.getElementById('rInput').value) || 0) * 10000;
            let s631 = 0, sQLD = 0;
            trades.forEach(t => { if(t.type==="00631L") s631 += t.qty; else sQLD += t.qty; });
            const totalAssets = (s631 * curP631) + (sQLD * curPQLD * 32.5) + rVal;
            const targetM = totalAssets / 2;
            const targetEach = targetM / 2;

            document.getElementById('res').innerHTML = `
                <div class="p-3 bg-blue-50 rounded-xl border-l-4 border-blue-500">
                    <p class="text-[10px] font-bold text-blue-500">00631L 建議持股</p>
                    <p class="font-black text-slate-800">${Math.round(targetEach/curP631).toLocaleString()} 股</p>
                </div>
                <div class="p-3 bg-indigo-50 rounded-xl border-l-4 border-indigo-500">
                    <p class="text-[10px] font-bold text-indigo-500">QLD 建議持股</p>
                    <p class="font-black text-slate-800">${Math.round(targetEach/32.5/curPQLD).toLocaleString()} 股</p>
                </div>
                <div class="p-3 bg-green-50 rounded-xl border-l-4 border-green-500">
                    <p class="text-[10px] font-bold text-green-500">現金 R 建議保留</p>
                    <p class="font-black text-slate-800">NT$ ${Math.round(totalAssets/2).toLocaleString()}</p>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        window.onload = () => {
            initChart();
            document.getElementById('curP631').value = localStorage.getItem('curP631') || 265;
            document.getElementById('curPQLD').value = localStorage.getItem('curPQLD') || 108;
            document.getElementById('rInput').value = localStorage.getItem('rInput') || 500;
            run();
        };
    </script>
</body>
</html>
